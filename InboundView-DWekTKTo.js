import{u as B,a as I,k as $,p as F,l as V,o as u,c as p,b as e,w as O,h as n,v as a,i as c,q as S,g as L,d as A,t as x,F as j,r as G,j as k,e as J,f as P,s as f,T as v}from"./index-R9P4HaMK.js";import{b as Q}from"./browser-JP79f-a9.js";const z={class:"page-container"},H={class:"page-content"},K={class:"card mb-4"},W={class:"grid grid-cols-2 gap-4 mb-4"},X={class:"grid grid-cols-2 gap-4 mb-4"},Y=["placeholder"],Z={class:"grid grid-cols-2 gap-4 mb-4"},tt={class:"grid grid-cols-2 gap-4 mb-4"},et={class:"grid grid-cols-2 gap-4 mb-4"},ot={class:"mb-4"},st={class:"card mb-4"},nt={class:"grid grid-cols-2 gap-4"},at={class:"card mb-4"},lt={class:"mb-4"},it={class:"mb-4"},rt={class:"mb-4"},dt={class:"mb-4"},ut={key:0,class:"mt-2"},pt=["src"],mt={class:"card mb-4"},bt={key:0},ct={class:"block text-sm font-medium text-gray-700 mb-2"},yt={class:"bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto"},gt={key:1,class:"text-sm text-gray-500"},xt={class:"card mb-4"},ft={key:0,class:"mb-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-600"},vt={class:"flex space-x-4"},kt=["disabled"],Ut={__name:"InboundView",setup(qt){const q=P(),M=B(),m=I(),y=k(!1),d=k(""),r=k([]),o=$({standard_number:"",name:"",manufacturer:"",concentration:null,uncertainty:null,batch:"",specification:"",quantity:1,unit:"瓶",category:"",production_date:"",expiry_date:"",storage_conditions:"",dilution_conditions:"",operator:m.userName,photo_url:"",storage_location:"",supplier:"",notes:""}),N=J(()=>m.userName);F(()=>[o.batch,o.quantity],()=>{b()}),V(()=>{o.operator=m.userName,b()});function b(){const l=o.quantity||1,t=(o.batch||"").trim();if(!t){r.value=[];return}const s=[];for(let i=1;i<=l;i++){const _=i.toString().padStart(2,"0");s.push(`${t}-${_}`)}r.value=s}async function C(l){try{const{data:t,error:s}=await f.from(v.MATERIALS).select("id").eq("unique_code",l).single();return!!t}catch{return!1}}async function E(l){const t=l.target.files[0];if(!t)return;const s=new FileReader;s.onload=i=>{o.photo_url=i.target.result},s.readAsDataURL(t)}async function R(l){try{const t={unique_code:l.unique_code,name:l.name,batch:l.batch,expiry_date:l.expiry_date,createdAt:new Date().toISOString()};return await Q.toDataURL(JSON.stringify(t),{width:200,margin:2,color:{dark:"#000000",light:"#ffffff"}})}catch(t){return console.error("生成二维码失败:",t),""}}async function h(){var l;if(!o.name||!o.batch||!o.expiry_date){d.value="请填写必填项（名称、批号和有效期）";return}if(o.quantity<1){d.value="数量必须大于0";return}if(r.value.length===0){d.value="请填写正确的批号";return}y.value=!0,d.value="";try{const t=[];for(let s=0;s<r.value.length;s++){const i=r.value[s];if(await C(i))throw new Error(`唯一标识 ${i} 已存在，请使用其他批号`);const w={standard_number:o.standard_number,name:o.name,manufacturer:o.manufacturer,concentration:o.concentration,uncertainty:o.uncertainty,batch:o.batch,specification:o.specification,quantity:1,unit:o.unit,production_date:o.production_date,expiry_date:o.expiry_date,storage_conditions:o.storage_conditions,dilution_conditions:o.dilution_conditions,operator:o.operator,photo_url:o.photo_url,storage_location:o.storage_location,supplier:o.supplier,category:o.category,notes:o.notes,created_by:(l=m.user)==null?void 0:l.id,unique_code:i,qr_code:"",status:"normal"},{data:g,error:U}=await f.from(v.MATERIALS).insert(w).select().single();if(U)throw U;t.push(g);const D=await R({...w,id:g.id});await f.from(v.MATERIALS).update({qr_code:D}).eq("id",g.id),await f.from(v.MATERIAL_LOGS).insert({material_id:g.id,operation:"inbound",operator:m.userName,quantity:1,previous_quantity:0,new_quantity:1,reason:"入库"})}await M.fetchMaterials(),alert(`入库成功！共${t.length}条记录`),q.push("/inventory")}catch(t){console.error("入库失败:",t),d.value=`入库失败: ${t.message}`}finally{y.value=!1}}function T(){q.back()}return V(()=>{b()}),(l,t)=>(u(),p("div",z,[e("div",H,[e("form",{onSubmit:O(h,["prevent"])},[e("div",K,[t[31]||(t[31]=e("h3",{class:"text-base font-semibold text-gray-800 mb-4"},"基本信息",-1)),e("div",W,[e("div",null,[t[18]||(t[18]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"标准物质编号",-1)),n(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>o.standard_number=s),type:"text",class:"input",placeholder:"请输入标准物质编号"},null,512),[[a,o.standard_number]])]),e("div",null,[t[19]||(t[19]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[c("名称 "),e("span",{class:"text-red-500"},"*")],-1)),n(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>o.name=s),type:"text",class:"input",placeholder:"请输入标准物质名称",required:""},null,512),[[a,o.name]])])]),e("div",X,[e("div",null,[t[20]||(t[20]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"厂家",-1)),n(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>o.manufacturer=s),type:"text",class:"input",placeholder:"请输入厂家名称"},null,512),[[a,o.manufacturer]])]),e("div",null,[t[21]||(t[21]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"操作人员",-1)),n(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>o.operator=s),type:"text",class:"input",placeholder:N.value,readonly:""},null,8,Y),[[a,o.operator]])])]),e("div",Z,[e("div",null,[t[22]||(t[22]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"浓度",-1)),n(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>o.concentration=s),type:"number",step:"any",class:"input",placeholder:"请输入浓度值"},null,512),[[a,o.concentration]])]),e("div",null,[t[23]||(t[23]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"不确定度",-1)),n(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>o.uncertainty=s),type:"number",step:"any",class:"input",placeholder:"请输入不确定度"},null,512),[[a,o.uncertainty]])])]),e("div",tt,[e("div",null,[t[24]||(t[24]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[c("批号 "),e("span",{class:"text-red-500"},"*")],-1)),n(e("input",{"onUpdate:modelValue":t[6]||(t[6]=s=>o.batch=s),type:"text",class:"input",placeholder:"请输入批号",required:"",onInput:b},null,544),[[a,o.batch]])]),e("div",null,[t[25]||(t[25]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"规格",-1)),n(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>o.specification=s),type:"text",class:"input",placeholder:"如: 100mL"},null,512),[[a,o.specification]])])]),e("div",et,[e("div",null,[t[26]||(t[26]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[c("数量(瓶) "),e("span",{class:"text-red-500"},"*")],-1)),n(e("input",{"onUpdate:modelValue":t[8]||(t[8]=s=>o.quantity=s),type:"number",min:"1",class:"input",placeholder:"请输入数量",required:"",onInput:b},null,544),[[a,o.quantity,void 0,{number:!0}]])]),e("div",null,[t[28]||(t[28]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"单位",-1)),n(e("select",{"onUpdate:modelValue":t[9]||(t[9]=s=>o.unit=s),class:"input"},[...t[27]||(t[27]=[L('<option value="瓶">瓶</option><option value="盒">盒</option><option value="支">支</option><option value="g">克(g)</option><option value="kg">千克(kg)</option><option value="mL">毫升(mL)</option><option value="L">升(L)</option>',7)])],512),[[S,o.unit]])])]),e("div",ot,[t[30]||(t[30]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"分类",-1)),n(e("select",{"onUpdate:modelValue":t[10]||(t[10]=s=>o.category=s),class:"input"},[...t[29]||(t[29]=[L('<option value="">请选择分类</option><option value="溶液类">溶液类</option><option value="粉末类">粉末类</option><option value="气体类">气体类</option><option value="固体类">固体类</option><option value="其他">其他</option>',6)])],512),[[S,o.category]])])]),e("div",st,[t[34]||(t[34]=e("h3",{class:"text-base font-semibold text-gray-800 mb-4"},"日期信息",-1)),e("div",nt,[e("div",null,[t[32]||(t[32]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"生产日期",-1)),n(e("input",{"onUpdate:modelValue":t[11]||(t[11]=s=>o.production_date=s),type:"date",class:"input"},null,512),[[a,o.production_date]])]),e("div",null,[t[33]||(t[33]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[c("有效期至 "),e("span",{class:"text-red-500"},"*")],-1)),n(e("input",{"onUpdate:modelValue":t[12]||(t[12]=s=>o.expiry_date=s),type:"date",class:"input",required:""},null,512),[[a,o.expiry_date]])])])]),e("div",at,[t[40]||(t[40]=e("h3",{class:"text-base font-semibold text-gray-800 mb-4"},"存放信息",-1)),e("div",lt,[t[35]||(t[35]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"存放位置",-1)),n(e("input",{"onUpdate:modelValue":t[13]||(t[13]=s=>o.storage_location=s),type:"text",class:"input",placeholder:"如: A-1-1"},null,512),[[a,o.storage_location]])]),e("div",it,[t[36]||(t[36]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"存储条件",-1)),n(e("textarea",{"onUpdate:modelValue":t[14]||(t[14]=s=>o.storage_conditions=s),class:"input",rows:"2",placeholder:"请输入存储条件，如：避光、冷藏等"},null,512),[[a,o.storage_conditions]])]),e("div",rt,[t[37]||(t[37]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"稀释条件",-1)),n(e("textarea",{"onUpdate:modelValue":t[15]||(t[15]=s=>o.dilution_conditions=s),class:"input",rows:"2",placeholder:"请输入稀释条件，如：临用新配、特定溶剂等"},null,512),[[a,o.dilution_conditions]])]),e("div",null,[t[38]||(t[38]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"供应商",-1)),n(e("input",{"onUpdate:modelValue":t[16]||(t[16]=s=>o.supplier=s),type:"text",class:"input",placeholder:"请输入供应商名称"},null,512),[[a,o.supplier]])]),e("div",dt,[t[39]||(t[39]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"上传照片",-1)),e("input",{onChange:E,type:"file",accept:"image/*",class:"input"},null,32),o.photo_url?(u(),p("div",ut,[e("img",{src:o.photo_url,alt:"预览图片",class:"max-w-xs h-auto rounded border"},null,8,pt)])):A("",!0)])]),e("div",mt,[t[41]||(t[41]=e("h3",{class:"text-base font-semibold text-gray-800 mb-4"},"唯一标识预览",-1)),t[42]||(t[42]=e("p",{class:"text-sm text-gray-600 mb-2"},[c(" 唯一标识 = "),e("span",{class:"font-mono font-bold text-primary-600"},"批号 + 序号")],-1)),r.value.length>0?(u(),p("div",bt,[e("label",ct,"将生成 "+x(r.value.length)+" 个唯一标识:",1),e("div",yt,[(u(!0),p(j,null,G(r.value,(s,i)=>(u(),p("div",{key:i,class:"text-sm font-mono text-primary-600 py-1 border-b border-gray-100 last:border-0"},x(s),1))),128))])])):(u(),p("p",gt," 请填写批号和数量后自动生成唯一标识 "))]),e("div",xt,[t[43]||(t[43]=e("h3",{class:"text-base font-semibold text-gray-800 mb-4"},"备注",-1)),n(e("textarea",{"onUpdate:modelValue":t[17]||(t[17]=s=>o.notes=s),class:"input",rows:"2",placeholder:"请输入备注信息"},null,512),[[a,o.notes]])]),d.value?(u(),p("div",ft,x(d.value),1)):A("",!0),e("div",vt,[e("button",{type:"button",onClick:T,class:"btn btn-secondary flex-1 py-3"}," 取消 "),e("button",{type:"submit",class:"btn btn-primary flex-1 py-3",disabled:y.value||r.value.length===0},x(y.value?"提交中...":"确认入库"),9,kt)])],32)])]))}};export{Ut as default};
