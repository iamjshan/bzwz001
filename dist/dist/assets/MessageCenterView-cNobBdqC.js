import{a as J,u as K,l as O,o as n,c as i,b as t,n as g,i as v,t as o,d as p,F as h,r as M,w as Q,h as b,q as C,v as q,L as W,D as X,j as u,e as T,M as Y,N as Z}from"./index-R9P4HaMK.js";const ee={class:"page-container"},te={class:"page-content"},se={class:"flex justify-between mb-4"},le={class:"flex space-x-2"},ae={key:0,class:"ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5"},oe={key:0,class:"flex justify-center py-12"},ne={key:1,class:"text-center py-12"},ie={class:"mt-2 text-gray-500"},re={key:2,class:"space-y-3"},de=["onClick"],ue={class:"flex justify-between items-start"},ce={class:"flex-1 min-w-0"},ve={class:"flex items-center mb-1"},me={class:"font-medium text-gray-800 truncate"},pe={key:0,class:"ml-2 w-2 h-2 bg-blue-500 rounded-full"},xe={class:"flex items-center text-sm text-gray-500 mb-2"},be={class:"text-sm text-gray-600 line-clamp-2"},ye={key:0,class:"mt-2 inline-flex items-center px-2 py-1 bg-gray-100 rounded-md text-xs text-gray-600"},fe={class:"flex flex-col items-end ml-4"},ge={key:3,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"},_e={class:"bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"},we={class:"flex justify-between items-start mb-4"},ke={class:"text-lg font-semibold text-gray-800"},he={class:"flex items-center text-sm text-gray-500 mb-4"},Me={class:"prose max-w-none mb-4"},Ce={key:0,class:"border-t pt-4"},Ie={class:"bg-gray-50 p-3 rounded-lg"},Ve={class:"text-sm"},je={class:"text-sm"},De={key:4,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"},Se={class:"bg-white rounded-xl p-6 w-full max-w-md"},Be={class:"mb-4"},Ne=["disabled"],Ue=["value"],$e={class:"mb-4"},ze=["disabled"],Le={class:"mb-4"},qe=["disabled"],Te={class:"mb-4"},Ae=["disabled"],Fe=["value"],He={class:"mb-4"},Re=["disabled"],Ee={class:"flex space-x-3 pt-4"},Pe=["disabled"],Ge=["disabled"],Oe={__name:"MessageCenterView",setup(Je){const m=J(),I=K(),x=u([]),y=u([]),f=u([]),_=u(!0),c=u("inbox"),w=u(!1),k=u(!1),d=u({}),r=u(!1),a=u({receiverId:"",title:"",content:"",relatedMaterialId:"",type:"system"}),V=T(()=>c.value==="inbox"?x.value.filter(l=>{var e;return l.receiver_id===((e=m.user)==null?void 0:e.id)}):x.value.filter(l=>{var e;return l.sender_id===((e=m.user)==null?void 0:e.id)})),j=T(()=>x.value.filter(l=>{var e;return l.receiver_id===((e=m.user)==null?void 0:e.id)&&!l.read}).length);function D(l){return new Date(l).toLocaleString("zh-CN")}function A(l){return{system:"系统",notification:"通知",alert:"警报",warning:"警告"}[l]||l}function F(l){return{system:"bg-gray-100 text-gray-700",notification:"bg-blue-100 text-blue-700",alert:"bg-red-100 text-red-700",warning:"bg-yellow-100 text-yellow-700"}[l]||"bg-gray-100 text-gray-700"}async function S(){var l;try{_.value=!0;const[e,s,L]=await Promise.all([W((l=m.user)==null?void 0:l.id),X(),I.fetchMaterials().then(()=>I.materials)]);x.value=e,y.value=s,f.value=L}catch(e){console.error("加载数据失败:",e),alert("加载数据失败: "+e.message)}finally{_.value=!1}}function B(l){const e=y.value.find(s=>s.id===l);return e?e.name:"未知用户"}function N(l){const e=y.value.find(s=>s.id===l);return e?e.name:"未知用户"}function U(l){const e=f.value.find(s=>s.id===l);return e?e.name:"未知材料"}function H(l){const e=f.value.find(s=>s.id===l);return e?e.unique_code:""}function R(l){var e;d.value=l,!l.read&&l.receiver_id===((e=m.user)==null?void 0:e.id)&&E(l.id),w.value=!0}async function E(l){try{await Y(l);const e=x.value.find(s=>s.id===l);e&&(e.read=!0)}catch(e){console.error("标记已读失败:",e)}}function $(){w.value=!1,d.value={}}function P(){a.value={receiverId:"",title:"",content:"",relatedMaterialId:"",type:"system"},k.value=!0}function z(){k.value=!1,a.value={receiverId:"",title:"",content:"",relatedMaterialId:"",type:"system"},r.value=!1}async function G(){var l;if(!a.value.receiverId||!a.value.content){alert("请填写必填项");return}r.value=!0;try{await Z({sender_id:(l=m.user)==null?void 0:l.id,receiver_id:a.value.receiverId,title:a.value.title||"新消息",content:a.value.content,type:a.value.type,related_material_id:a.value.relatedMaterialId||null}),alert("消息发送成功"),await S(),z()}catch(e){console.error("发送消息失败:",e),alert("发送失败: "+e.message)}finally{r.value=!1}}return O(async()=>{await S()}),(l,e)=>(n(),i("div",ee,[t("div",te,[e[27]||(e[27]=t("div",{class:"mb-6"},[t("h2",{class:"text-xl font-semibold text-gray-800"},"消息中心"),t("p",{class:"text-sm text-gray-500 mt-1"},"系统通知和用户消息")],-1)),t("div",se,[t("div",le,[t("button",{onClick:e[0]||(e[0]=s=>c.value="inbox"),class:g(["px-4 py-2 rounded-lg text-sm font-medium",c.value==="inbox"?"bg-primary-100 text-primary-700":"text-gray-500 hover:bg-gray-100"])},[e[7]||(e[7]=v(" 收件箱 ",-1)),j.value>0?(n(),i("span",ae,o(j.value),1)):p("",!0)],2),t("button",{onClick:e[1]||(e[1]=s=>c.value="sent"),class:g(["px-4 py-2 rounded-lg text-sm font-medium",c.value==="sent"?"bg-primary-100 text-primary-700":"text-gray-500 hover:bg-gray-100"])}," 已发送 ",2)]),t("button",{onClick:P,class:"btn btn-primary flex items-center"},[...e[8]||(e[8]=[t("svg",{class:"w-5 h-5 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1),v(" 新建消息 ",-1)])])]),_.value?(n(),i("div",oe,[...e[9]||(e[9]=[t("svg",{class:"animate-spin h-8 w-8 text-primary-600",fill:"none",viewBox:"0 0 24 24"},[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)])])):V.value.length===0?(n(),i("div",ne,[e[10]||(e[10]=t("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})],-1)),t("p",ie,o(c.value==="inbox"?"暂无收到的消息":"暂无已发送的消息"),1)])):(n(),i("div",re,[(n(!0),i(h,null,M(V.value,s=>(n(),i("div",{key:s.id,class:g(["card p-4 cursor-pointer transition-colors",s.read?"bg-white":"bg-blue-50"]),onClick:L=>R(s)},[t("div",ue,[t("div",ce,[t("div",ve,[t("h3",me,o(s.title||"未命名消息"),1),s.read?p("",!0):(n(),i("span",pe))]),t("div",xe,[t("span",null,o(c.value==="inbox"?`来自 ${B(s.sender_id)}`:`发给 ${N(s.receiver_id)}`),1),e[11]||(e[11]=t("span",{class:"mx-2"},"•",-1)),t("span",null,o(D(s.created_at)),1)]),t("p",be,o(s.content),1),s.related_material_id?(n(),i("div",ye,[e[12]||(e[12]=t("svg",{class:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"})],-1)),v(" 关联材料: "+o(U(s.related_material_id)),1)])):p("",!0)]),t("div",fe,[t("span",{class:g(["badge",F(s.type)])},o(A(s.type)),3)])])],10,de))),128))])),w.value?(n(),i("div",ge,[t("div",_e,[t("div",we,[t("h3",ke,o(d.value.title||"未命名消息"),1),t("button",{onClick:$,class:"text-gray-500 hover:text-gray-700"},[...e[13]||(e[13]=[t("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),t("div",he,[t("span",null,o(c.value==="inbox"?`来自 ${B(d.value.sender_id)}`:`发给 ${N(d.value.receiver_id)}`),1),e[14]||(e[14]=t("span",{class:"mx-2"},"•",-1)),t("span",null,o(D(d.value.created_at)),1)]),t("div",Me,[t("p",null,o(d.value.content),1)]),d.value.related_material_id?(n(),i("div",Ce,[e[17]||(e[17]=t("h4",{class:"font-medium text-gray-800 mb-2"},"相关材料",-1)),t("div",Ie,[t("p",Ve,[e[15]||(e[15]=t("strong",null,"名称:",-1)),v(" "+o(U(d.value.related_material_id)),1)]),t("p",je,[e[16]||(e[16]=t("strong",null,"编码:",-1)),v(" "+o(H(d.value.related_material_id)),1)])])])):p("",!0),t("div",{class:"flex justify-end pt-4"},[t("button",{onClick:$,class:"btn btn-secondary px-4 py-2"}," 关闭 ")])])])):p("",!0),k.value?(n(),i("div",De,[t("div",Se,[e[26]||(e[26]=t("h3",{class:"text-lg font-semibold text-gray-800 mb-4"},"新建消息",-1)),t("form",{onSubmit:Q(G,["prevent"])},[t("div",Be,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[v("接收人 "),t("span",{class:"text-red-500"},"*")],-1)),b(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>a.value.receiverId=s),class:"input w-full",required:"",disabled:r.value},[e[18]||(e[18]=t("option",{value:""},"请选择接收人",-1)),(n(!0),i(h,null,M(y.value,s=>(n(),i("option",{key:s.id,value:s.id},o(s.name)+" ("+o(s.email)+") ",9,Ue))),128))],8,Ne),[[C,a.value.receiverId]])]),t("div",$e,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"主题",-1)),b(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>a.value.title=s),type:"text",class:"input w-full",placeholder:"请输入消息主题",maxlength:"200",disabled:r.value},null,8,ze),[[q,a.value.title,void 0,{trim:!0}]])]),t("div",Le,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[v("内容 "),t("span",{class:"text-red-500"},"*")],-1)),b(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=s=>a.value.content=s),class:"input w-full",rows:"4",placeholder:"请输入消息内容",maxlength:"1000",required:"",disabled:r.value},null,8,qe),[[q,a.value.content,void 0,{trim:!0}]])]),t("div",Te,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"关联材料",-1)),b(t("select",{"onUpdate:modelValue":e[5]||(e[5]=s=>a.value.relatedMaterialId=s),class:"input w-full",disabled:r.value},[e[22]||(e[22]=t("option",{value:""},"不关联材料",-1)),(n(!0),i(h,null,M(f.value,s=>(n(),i("option",{key:s.id,value:s.id},o(s.name)+" ("+o(s.unique_code)+") ",9,Fe))),128))],8,Ae),[[C,a.value.relatedMaterialId]])]),t("div",He,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"消息类型",-1)),b(t("select",{"onUpdate:modelValue":e[6]||(e[6]=s=>a.value.type=s),class:"input w-full",disabled:r.value},[...e[24]||(e[24]=[t("option",{value:"system"},"系统消息",-1),t("option",{value:"notification"},"通知",-1),t("option",{value:"alert"},"警报",-1),t("option",{value:"warning"},"警告",-1)])],8,Re),[[C,a.value.type]])]),t("div",Ee,[t("button",{onClick:z,type:"button",class:"btn btn-secondary flex-1 py-2",disabled:r.value}," 取消 ",8,Pe),t("button",{type:"submit",class:"btn btn-primary flex-1 py-2",disabled:r.value||!a.value.receiverId||!a.value.content},o(r.value?"发送中...":"发送"),9,Ge)])],32)])])):p("",!0)])]))}};export{Oe as default};
